---
title: cache-control
date: 2020-05-11
tags:
    - http
    - 缓存
---

## 缓存机制
网络链路是影响数据传输最主要的因素，充分利用缓存从本地获取数据可以极大提升性能。

简单而言，浏览器请求一个资源，没有缓存时发送请求。服务器返回资源，浏览器缓存并使用。后续再次请求该资源时即可直接使用缓存资源。

实际的缓存策略更加全面、复杂。
## Cache-Control字段
浏览器和服务器都可用，用来协商缓存资源的细节。

除此之外，还有代理服务器场景也有独特的机制和字段，暂不论及。

### 字段值
字段的值可用来标记资源的过期时间和缓存性等。

max-age：缓存资源的生存时间，从响应报文离开服务器开始计时。格式为：`Cache-Control:max-age=30`，表示缓存资源的生存时间为30s。

#### 其他常见关键字
- no_store:表示禁止缓存。用于更新频率较快的资源。
- no_cache:表示可以缓存，在使用前需向服务器验证资源是否过期。
- must-revalidate:表示在缓存生存时间内，可直接使用资源，生存时间之后使用需向服务器验证是否过期。用于更新频率较慢的资源。

浏览器可在请求中包含标准的缓存请求指令与服务器协商，但最终返回资源的缓存细节由响应报文中缓存响应指令决定。
## 缓存验证
常见的情景，浏览器已经有缓存资源，在下次请求时，需向服务器验证是否过期。
### 弱验证
在时间粒度上的验证，之前响应报文如果有last-modify字段，可在后续请求时带上if-modify-since，其值为last-modify的值，再由服务器判断之前到目前资源是否更新。

无更新时，返回状态304 not modify。有更新时，返回更新的资源。

### 强验证

上述时间粒度上的验证在更新频率较高时有明显缺点。可对每次更新的资源添加唯一标识。

响应报文中添加Etag（主体标签）字段，请求报文中添加if-none-match，其值为Etag值。

可匹配到时，说明资源未过期；匹配不到时，返回更新的资源。